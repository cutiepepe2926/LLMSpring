<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.llmspring.mapper.DailyReportMapper">

    <select id="selectReportByDate" resultType="com.example.llmspring.vo.DailyReportVO">
        SELECT * FROM DailyReport
        WHERE project_id = #{projectId} AND user_id = #{userId} AND report_date = #{date}
    </select>

    <insert id="insertReport" useGeneratedKeys="true" keyProperty="reportId">
        INSERT INTO DailyReport (
            project_id, user_id, report_date, title, content,
            status, commit_count, is_published, original_content
        ) VALUES (
                     #{projectId}, #{userId}, #{reportDate}, #{title}, #{content},
                     'DRAFT', #{commitCount}, false, true
                 )
    </insert>

    <select id="selectReportById" resultType="com.example.llmspring.vo.DailyReportVO">
        SELECT * FROM DailyReport WHERE report_id = #{reportId}
    </select>

    <update id="updateReport">
        UPDATE DailyReport
        SET title = #{title},
            content = #{content},
            updated_at = NOW()
        WHERE report_id = #{reportId}
    </update>

    <update id="updateReportPublishStatus">
        UPDATE DailyReport
        SET is_published = true,
            status = #{status},
            updated_at = NOW()
        WHERE report_id = #{reportId}
    </update>

    <insert id="insertChatLog">
        INSERT INTO DailyReportChatLog (role, message, report_id, suggestion_content, is_applied)
        VALUES (#{role}, #{message}, #{reportId}, #{suggestionContent}, #{isApplied})
    </insert>

    <select id="selectChatLogs" resultType="com.example.llmspring.vo.DailyReportChatLogVO">
        SELECT * FROM DailyReportChatLog
        WHERE report_id = #{reportId}
        ORDER BY created_at ASC
    </select>

    <select id="selectUserName" resultType="String">
        SELECT name FROM User WHERE user_id = #{userId}
    </select>

</mapper>